# Архитектура AI Travel Agent

## Обзор системы

Проект построен на современном стеке с разделением на клиент-серверную архитектуру и использованием Telegram как основного канала взаимодействия.

## Технологический стек

### Backend
- **Node.js + TypeScript** - основная платформа
- **Express.js** - веб-сервер
- **Drizzle ORM** - работа с базой данных
- **PostgreSQL (Neon)** - основная БД
- **node-telegram-bot-api** - интеграция с Telegram
- **OpenRouter API** - AI анализ текста
- **Level.Travel API** - поиск туров

### Frontend
- **React + TypeScript** - UI фреймворк
- **Vite** - сборщик
- **Tailwind CSS** - стилизация
- **React Query** - управление состоянием
- **Telegram WebApp SDK** - интеграция с Telegram

## Архитектурные компоненты

### 1. Telegram Bot (`/server/bot`)
- **FSM (Finite State Machine)** - управление состоянием диалогов
- **Handlers** - обработчики команд и сообщений
- **Onboarding** - приветственные карточки

### 2. Сервисы (`/server/services`)
- **OpenRouter Service** - анализ текстовых запросов
- **Monitoring Service** - фоновый поиск туров
- **Groups Service** - групповые функции

### 3. База данных (`/shared/schema.ts`)
```
profiles           - профили пользователей
tourPriorities     - веса параметров
groupProfiles      - групповые профили
tours              - найденные туры
tourMatches        - соответствия туров профилям
groupTourVotes     - голосования в группах
monitoringTasks    - задачи мониторинга
```

### 4. API Routes (`/server/routes.ts`)
Все endpoints начинаются с `/api/`:
- Профили пользователей
- Анализ запросов
- Поиск туров
- Групповые функции

## Ключевые алгоритмы

### Анализ текстовых запросов
1. Текст отправляется в OpenRouter API
2. Извлекаются параметры (страны, бюджет, даты)
3. Определяются веса важности
4. Fallback на регулярные выражения

### Расчет соответствия туров
```javascript
score = Σ(параметр × вес) / Σ(весов)
```
Учитываются:
- Звездность отеля
- Линия пляжа
- Тип питания
- Цена
- Рейтинг

### Агрегация групповых профилей
1. Собираются профили всех участников
2. Страны объединяются
3. Бюджет усредняется и умножается на количество участников
4. Даты берутся как пересечение
5. Веса усредняются

## Потоки данных

### Текстовый запрос пользователя
```
Пользователь → Telegram Bot → OpenRouter → 
→ Сохранение в БД → Поиск туров → 
→ Расчет соответствия → Уведомление
```

### Групповой поиск
```
Группа → Сбор профилей → Агрегация → 
→ Поиск туров → Голосование → Результаты
```

### Фоновый мониторинг
```
Scheduler (каждый час) → Проверка задач → 
→ Поиск новых туров → Фильтрация (>85%) → 
→ Уведомления пользователям
```

## Безопасность

- API ключи в переменных окружения
- Валидация входных данных (TODO)
- Rate limiting (TODO)
- CORS настройки (TODO)

## Масштабирование

Текущая архитектура позволяет:
- Горизонтальное масштабирование сервера
- Добавление новых провайдеров туров
- Расширение AI функций
- Добавление новых типов уведомлений

## Точки расширения

1. **Новые провайдеры** - добавить в `/server/providers`
2. **Новые параметры** - расширить схему БД
3. **Новые AI модели** - обновить OpenRouter сервис
4. **Новые команды бота** - добавить в handlers