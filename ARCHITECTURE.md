# Архитектура AI Travel Agent

## Обзор системы

Проект построен на клиент‑серверной архитектуре с Telegram в качестве основного интерфейса. MVP ориентирован на один тур‑провайдер (Level.Travel) для быстрых итераций и валидации ценности.

## Технологический стек

### Backend
- Node.js + TypeScript
- Express.js
- Drizzle ORM + PostgreSQL
- node-telegram-bot-api (polling/webhook)
- OpenRouter API (опционально) + fallback парсинг
- Level.Travel API

### Frontend
- React + TypeScript (Vite)
- Tailwind CSS
- Telegram WebApp SDK

## Компоненты

### 1. Telegram Bot (`/server/bot`)
- Обработчики команд и сообщений
- Поддержка polling и webhook (через `TELEGRAM_USE_WEBHOOK`)

### 2. Сервисы (`/server/services`)
- OpenRouter: анализ текстовых запросов
- Monitoring: фоновый поиск туров (порог уведомлений ≥ 85%)
- Groups: агрегация предпочтений и голосование

### 3. База данных (`/shared/schema.ts`)
```
profiles           - профили пользователей
tourPriorities     - веса параметров
groupProfiles      - групповые профили
tours              - найденные туры
tourMatches        - соответствия туров профилям
groupTourVotes     - голосования в группах
monitoringTasks    - задачи мониторинга
```

### 4. API (`/server/routes.ts`)
- Версионирование: `/api/v1`
- Health: `/api/health`, `/metrics`
- Telegram webhook: `POST /api/telegram/webhook` (если включён)

## Ключевые алгоритмы

### Анализ текстовых запросов
1. Запрос → OpenRouter (если есть ключ) → нормализация
2. Fallback: базовый парсинг по регулярным выражениям

### Ранжирование туров
```
score = Σ(параметр × вес) / Σ(весов)
```
Параметры: звезды, линия пляжа, питание, цена, рейтинг, даты, длительность.

### Групповая агрегация
- Объединение стран, усреднение бюджета
- Пересечение дат
- Усреднение весов

### Фоновый мониторинг
- Периодический проход по `monitoringTasks`
- Поиск, скоринг, сохранение, уведомления
- Деактивация задач‑дедлайнов по достижении дат

## Безопасность
- JWT, CSRF, Helmet, XSS‑санация
- Rate limiting: глобальный, для поиска, для webhook
- Валидация Zod

## Масштабирование
- Горизонтальное масштабирование API
- Добавление новых провайдеров через модульную систему провайдеров
- Вынесение AI в отдельный воркер/сервис

## Точки расширения
1. Новые провайдеры туров/отелей/авиа — `/server/providers`
2. Новые параметры и нормы — `shared/schema.ts` и сервисы нормализации
3. AI‑модели и кеш — `services/openrouter.ts`