# AI Integration Guide

## Обзор

AI Travel Agent использует многоуровневую систему AI-провайдеров для анализа текстовых запросов пользователей и генерации персонализированных рекомендаций по турам.

## Архитектура AI

### Fallback цепочка провайдеров

1. **OpenRouter (бесплатные модели)**
   - Mistral 7B Instruct
   - Zephyr 7B Beta
   - OpenChat 3.5
   - MythoMist 7B
   - Nous Capybara 7B

2. **YandexGPT (платный резерв)**
   - YandexGPT Lite
   - Низкая стоимость (~0.2₽ за 1000 токенов)

3. **Базовый парсинг**
   - Регулярные выражения
   - Ключевые слова
   - Эвристики

### Как работает fallback

```typescript
// Псевдокод логики
for (const model of openRouterModels) {
  try {
    return await callOpenRouter(model);
  } catch (error) {
    continue; // Пробуем следующую модель
  }
}

if (yandexGptEnabled) {
  try {
    return await callYandexGpt();
  } catch (error) {
    log.warn('YandexGPT failed');
  }
}

// Если все AI не работают
return basicTextParsing(message);
```

## Промпты

### 1. Анализ туристических запросов

```
Ты - профессиональный AI-ассистент туристического агентства с многолетним опытом подбора туров.

ТВОЯ ЗАДАЧА:
Проанализировать текстовое сообщение клиента и извлечь все параметры для поиска идеального тура.

ВАЖНЫЕ ПРАВИЛА:
1. Извлекай ВСЕ упомянутые параметры, даже косвенные упоминания
2. Интерпретируй пожелания клиента, учитывая контекст и скрытые потребности
3. Если клиент упоминает характеристики отеля - преобразуй их в приоритеты
4. Учитывай сезонность и особенности направлений
5. При упоминании бюджета "на человека" или "на двоих" - правильно интерпретируй
```

**Ключевые особенности:**
- Детальное описание всех параметров
- Примеры интерпретации
- Учет контекста и синонимов
- Веса приоритетов от 0 до 10

### 2. Анализ соответствия тура

```
Ты - опытный турагент с 15-летним стажем. Твоя задача - объяснить клиенту, насколько конкретный тур соответствует его запросу.

ПРАВИЛА:
1. Будь честным - укажи как плюсы, так и минусы
2. Используй простой и понятный язык
3. Фокусируйся на ключевых параметрах важных для клиента
4. Давай конкретные рекомендации
5. Ответ должен быть 2-3 предложения
```

## Настройка

### Переменные окружения

```bash
# OpenRouter API (основной провайдер)
OPENROUTER_API_KEY=your_openrouter_api_key

# Yandex GPT API (резервный провайдер)
YANDEX_GPT_API_KEY=your_yandex_gpt_api_key
```

### Получение API ключей

1. **OpenRouter**
   - Регистрация: https://openrouter.ai
   - Получить ключ: https://openrouter.ai/keys
   - Бесплатные модели доступны сразу

2. **YandexGPT**
   - Создать аккаунт: https://cloud.yandex.ru
   - Активировать YandexGPT в каталоге сервисов
   - Создать API-ключ в IAM

## Примеры использования

### Анализ простого запроса

**Вход:**
```
Хочу недорого отдохнуть на море
```

**Выход AI:**
```json
{
  "vacationType": "beach",
  "budget": 100000,
  "peopleCount": 2,
  "priorities": {
    "starRating": 5,
    "beachLine": 7,
    "mealType": 5,
    "priceValue": 10,
    "hotelRating": 5
  }
}
```

### Анализ сложного запроса

**Вход:**
```
Планируем поездку в Турцию с женой и двумя детьми (5 и 8 лет) в июле. 
Хотелось бы отель с хорошей детской анимацией, аквапарком, первая линия обязательно. 
Питание все включено. Бюджет до 300 тысяч на всех. 
Важно чтобы был песчаный пляж и пологий вход в море.
```

**Выход AI:**
```json
{
  "vacationType": "family",
  "countries": ["Турция"],
  "budget": 300000,
  "startDate": "2024-07-01",
  "endDate": "2024-07-14",
  "peopleCount": 4,
  "priorities": {
    "starRating": 7,
    "beachLine": 10,
    "mealType": 10,
    "familyFriendly": 10,
    "animation": 9,
    "location": 8,
    "priceValue": 7,
    "roomQuality": 6
  }
}
```

## Мониторинг и отладка

### Логирование

Все AI вызовы логируются с деталями:
```
[INFO] Trying OpenRouter with model: mistralai/mistral-7b-instruct:free
[WARN] Failed with model mistralai/mistral-7b-instruct:free: Rate limit exceeded
[INFO] Trying YandexGPT as fallback
[INFO] Successfully got response from YandexGPT
```

### Метрики производительности

- Среднее время ответа OpenRouter: 2-3 секунды
- Среднее время ответа YandexGPT: 1-2 секунды
- Базовый парсинг: < 100мс

### Обработка ошибок

1. **Timeout (15 секунд)** - переход к следующему провайдеру
2. **Rate limit** - переход к следующей модели/провайдеру
3. **Invalid JSON** - повтор с другой моделью или базовый парсинг
4. **Network error** - экспоненциальный backoff не применяется, сразу fallback

## Best Practices

1. **Всегда имейте fallback** - базовый парсинг должен покрывать основные сценарии
2. **Кешируйте результаты** - одинаковые запросы не должны вызывать AI повторно
3. **Мониторьте расходы** - YandexGPT платный, следите за использованием
4. **Тестируйте промпты** - регулярно проверяйте качество ответов
5. **Версионируйте промпты** - сохраняйте историю изменений

## Расширение функциональности

### Добавление нового провайдера

1. Добавьте конфигурацию в `AIProvider` interface
2. Реализуйте вызов API в `tryAIProvider`
3. Добавьте в цепочку fallback
4. Напишите тесты

### Улучшение промптов

1. Собирайте примеры реальных запросов
2. Анализируйте ошибки парсинга
3. Добавляйте новые примеры в промпт
4. A/B тестируйте разные версии

## Troubleshooting

### AI не работает

1. Проверьте наличие API ключей в `.env`
2. Проверьте лимиты и баланс аккаунтов
3. Проверьте логи на предмет ошибок
4. Убедитесь что fallback работает

### Неточный парсинг

1. Проверьте промпт на полноту
2. Добавьте больше примеров
3. Увеличьте температуру для креативности
4. Рассмотрите fine-tuning модели