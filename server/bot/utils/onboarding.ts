import TelegramBot from 'node-telegram-bot-api';
import { getUserState, setUserState } from '../fsm';

/**
 * –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 * –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
// –ö–∞—Ä—Ç–æ—á–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Telegram
export const ONBOARDING_CARDS = [
  'üß† <b>AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ç—É—Ä–∞–º</b>\n–Ø –ø–æ–º–æ–≥–∞—é –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π',
  'ü§ñ <b>–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π</b>\n–ò–∑—É—á–∞—é –≤–∞—à–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ —Å—Ç–∏–ª—å –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π',
  'üß≥ <b>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</b>\n–ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏',
  'üéØ <b>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b>\n–ü–æ–∫–∞–∑—ã–≤–∞—é —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–µ —Ç—É—Ä—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–∞—à–∏–º –∂–µ–ª–∞–Ω–∏—è–º',
  'üîé <b>–ü–æ–∏—Å–∫ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤</b>\n–ü–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏',
  'üí∞ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –Ω–∞ –±—É–¥—É—â–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'
];

/**
 * –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è "–∂–∏–≤–æ–≥–æ" —ç—Ñ—Ñ–µ–∫—Ç–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
 * –£–º–µ–Ω—å—à–µ–Ω–∞ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 */
export const CARD_DELAY = 300;

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –∫–Ω–æ–ø–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
 * @param bot –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
 * @param chatId ID —á–∞—Ç–∞
 * @param userId ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param force –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–¥–µ–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
 */
export async function sendIntroCards(
  bot: TelegramBot, 
  chatId: number, 
  userId: string,
  force: boolean = false
): Promise<void> {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  const userState = getUserState(userId);
  if (!force && userState?.onboardingShown) {
    console.log(`–û–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∂–µ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
    return;
  }

  // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–æ–∫–∞–∑–∞–Ω
  if (userState) {
    setUserState(userId, {
      ...userState,
      onboardingShown: true
    });
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ${ONBOARDING_CARDS.length} –æ–Ω–±–æ—Ä–¥–∏–Ω–≥-–∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
  
  for (const card of ONBOARDING_CARDS) {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ Markdown –¥–ª—è –±–æ–ª—å—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      const htmlCard = card
        .replace(/\*([^*]+)\*/g, '<b>$1</b>')  // *–∂–∏—Ä–Ω—ã–π* -> <b>–∂–∏—Ä–Ω—ã–π</b>
        .replace(/\_([^_]+)\_/g, '<i>$1</i>'); // _–∫—É—Ä—Å–∏–≤_ -> <i>–∫—É—Ä—Å–∏–≤</i>
      
      await bot.sendMessage(chatId, htmlCard, { parse_mode: 'HTML' });
      console.log(`–ö–∞—Ä—Ç–æ—á–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${htmlCard.substring(0, 20)}...`);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
      await new Promise(resolve => setTimeout(resolve, CARD_DELAY));
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      await bot.sendMessage(chatId, card.replace(/[\*\_]/g, ''));
      await new Promise(resolve => setTimeout(resolve, CARD_DELAY));
    }
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
  const markup = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üëâ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É', callback_data: 'start_profile' }]
      ]
    }
  };

  await bot.sendMessage(
    chatId, 
    '–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –ø–æ–¥–±–æ—Ä –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–≤–æ–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö!',
    markup
  );
}