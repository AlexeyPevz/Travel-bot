name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci --no-audit --no-fund
      - run: npm run build
      - run: npm run test -- --passWithNoTests
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/tourtinder_test
          TELEGRAM_TOKEN: test
          OPENROUTER_API_KEY: test
          LEVELTRAVEL_API_KEY: test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_PASSWORD: ''
          LOG_LEVEL: error
          CSRF_SECRET: test_csrf_secret_min_32_characters
          COOKIE_SECRET: test_cookie_secret_min_32_characters
          SESSION_SECRET: test_session_secret_min_32_characters
          APP_URL: http://localhost:5000
          LEVEL_TRAVEL_PARTNER: '123456'
          LEVEL_TRAVEL_MARKER: marker
          LEVEL_TRAVEL_AFFILIATE_URL: https://example.com/aff